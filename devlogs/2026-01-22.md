# Devlog - 2026-01-22

## Summary
Updated the default example in the Blink Message Playground frontend to demonstrate nested classes and subclasses, replacing the overly simple Person example with a more comprehensive Company/Employee hierarchy.

## Changes Made

### 1. Updated Default Schema (`frontend/src/App.tsx`)

**Previous Schema:**
```
namespace Demo
Person/1 -> string Name, u32 Age
```

**New Schema:**
```
namespace Demo

# Base class for address information
Address/1 -> string Street, string City, u32 ZipCode

# Employee class with nested Address
Employee/2 -> string Name, u32 Age, Address HomeAddress

# Manager subclass extends Employee with additional fields
Manager/3 : Employee -> string Department, u32 TeamSize

# Company class with nested Manager
Company/4 -> string CompanyName, Manager CEO
```

### 2. Updated Example Messages

Generated correct example messages for all 5 formats using the backend API:

- **JSON**: Nested objects with proper structure
- **Tag**: Uses curly braces `{}` for nested objects (e.g., `CEO={Name=Alice,...}`)
- **XML**: Uses namespace prefix `ns0:Company xmlns:ns0="Demo"`
- **Compact Binary**: 59 bytes
- **Native Binary**: 112 bytes

### 3. Created Test Script

Created `backend/test_nested_example.py` to:
- Validate the new schema compiles correctly
- Test conversion between all formats
- Generate the correct binary hex strings for the example messages
- Verify round-trip conversion works

## Features Demonstrated

### Nested Classes
- `Employee` contains an `Address` object in the `HomeAddress` field
- `Company` contains a `Manager` object in the `CEO` field
- Shows how Blink handles complex object hierarchies

### Subclasses (Inheritance)
- `Manager/3 : Employee` - Manager extends Employee
- Manager inherits all fields from Employee (Name, Age, HomeAddress)
- Manager adds additional fields (Department, TeamSize)
- Demonstrates Blink's inheritance capabilities

### Multiple Type IDs
- Address/1
- Employee/2
- Manager/3
- Company/4
- Shows how different types are identified in binary formats

## Example Data Structure

```
Company: TechCorp
└── CEO: Alice (Manager)
    ├── Name: Alice
    ├── Age: 45
    ├── HomeAddress: (Address)
    │   ├── Street: 123 Main St
    │   ├── City: San Francisco
    │   └── ZipCode: 94102
    ├── Department: Engineering
    └── TeamSize: 50
```

## Technical Details

### Binary Format Sizes
- **Compact Binary**: 59 bytes (variable-length encoding)
- **Native Binary**: 112 bytes (fixed-width fields with predictable offsets)

### Tag Format Syntax
The Tag format uses curly braces for nested objects:
```
@Demo:Company|CompanyName=TechCorp|CEO={Name=Alice,Age=45,HomeAddress={Street=123 Main St,City=San Francisco,ZipCode=94102},Department=Engineering,TeamSize=50}
```

### Known Issues
- XML format appears to have a bug where nested objects aren't fully serialized (shows `<CEO />` as self-closing)
- This is a known issue with the XML encoder that needs to be addressed separately

## Testing

All format conversions tested successfully via the backend API:
- ✅ Schema compiles without errors
- ✅ JSON → All formats conversion works
- ✅ Tag format displays nested structure correctly
- ✅ Binary formats encode/decode properly
- ⚠️ XML format has serialization issue with nested objects

## Impact

This change makes the default example much more realistic and educational:
1. **Better demonstrates Blink's capabilities** - Shows inheritance and nesting
2. **More realistic use case** - Company organizational structure is relatable
3. **Encourages exploration** - Users can see complex data relationships
4. **Educational value** - Teaches both nested classes and subclasses

The previous simple Person example was too basic and didn't showcase what makes Blink powerful.

## Files Modified

1. `frontend/src/App.tsx` - Updated EXAMPLE_SCHEMA and EXAMPLE_MESSAGES constants
2. `backend/test_nested_example.py` - Created new test script (can be kept for future validation)

## Startup Scripts Added

To make it easier to run the playground, created multiple startup options:

### 1. PowerShell Script (`start.ps1`)
- Checks if ports 8000 and 3000 are already in use
- Starts backend and frontend in separate PowerShell windows
- Provides clear status messages and URLs
- Best for Windows users with PowerShell

### 2. Batch File (`start.bat`)
- Simple Windows batch script
- No PowerShell execution policy requirements
- Starts both servers in separate command windows
- Alternative for users who prefer batch files

### 3. Makefile (`Makefile`)
- Cross-platform build automation
- Targets:
  - `make start` - Start both servers
  - `make start-backend` - Backend only
  - `make start-frontend` - Frontend only
  - `make install` - Install all dependencies
  - `make test` - Run tests
  - `make clean` - Clean build artifacts
- Works on Windows, Linux, and macOS
- Detects OS and uses appropriate commands

### 4. Updated README.md
- Added "Quick Start" section prominently near the top
- Documents all three startup methods
- Lists playground features
- Provides manual startup commands as alternatives

**Usage:**
```bash
# Windows PowerShell
.\start.ps1

# Windows Command Prompt
start.bat

# Cross-platform (Make)
make start
```

All methods start:
- Backend API at http://127.0.0.1:8000
- Frontend App at http://localhost:3000

## JSON Inheritance Verification

Reviewed the Blink JSON Format Specification (beta4) to verify how inheritance should be handled in JSON encoding.

**Question:** Should base class properties go into a special `$base` property, or be flattened?

**Answer:** ✅ **Flattened** (current implementation is correct)

### Evidence from Spec

According to section 2.14 "Dynamic Group" (lines 176-202):
```json
{
  "$type": "Frame", 
  "Content": { 
    "$type": "Rect",   // Rect extends Shape
    "Width": 10,       // Fields directly in object
    "Height": 20       // No $base wrapper
  }
}
```

### Current Implementation

The `jsonfmt.py` implementation correctly uses `group.all_fields()` which:
1. Recursively yields fields from base class(es) first
2. Then yields fields from derived class
3. All fields are placed directly in the JSON object

**Example:**
```json
{
  "$type": "Demo:Manager",
  "Name": "Alice",           // From Employee (base)
  "Age": 45,                 // From Employee (base)
  "HomeAddress": {...},      // From Employee (base)
  "Department": "Engineering", // From Manager (derived)
  "TeamSize": 50             // From Manager (derived)
}
```

The only special properties in Blink JSON are:
- `$type` - Required, indicates the group type
- `$extension` - Optional, contains extension messages

**Conclusion:** No changes needed. The implementation correctly follows the spec.

See `doc/JSON_INHERITANCE_ANALYSIS.md` for detailed analysis.

## Next Steps

- Consider adding more example schemas to a library (Phase 5 task)
- Fix XML encoder bug with nested objects
- Add inline documentation explaining the inheritance syntax (`:` operator)
